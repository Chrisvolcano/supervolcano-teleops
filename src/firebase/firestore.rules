rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.role == "admin" ||
        request.auth.token.role == "superadmin" ||
        request.auth.token.role == "partner_admin"
      );
    }

    function isFieldWorker() {
      return isAuthenticated() && (
        request.auth.token.role == "oem_teleoperator" ||
        request.auth.token.role == "property_cleaner"
      );
    }

    function isManager() {
      return isAuthenticated() && (
        request.auth.token.role == "partner_manager" ||
        request.auth.token.role == "location_owner"
      );
    }

    function isOrgUser() {
      return isAuthenticated() && (
        request.auth.token.role == "partner_manager" ||
        request.auth.token.role == "location_owner" ||
        request.auth.token.role == "oem_teleoperator" ||
        request.auth.token.role == "property_cleaner"
      );
    }

    function getOrganizationId() {
      return request.auth.token.organizationId;
    }

    function partnerMatches(partnerOrgId) {
      return isAdmin() ||
        (isAuthenticated() && request.auth.token.partnerId == partnerOrgId);
    }

    // Organizations collection
    match /organizations/{organizationId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.id == getOrganizationId())
      );
      allow write: if isAdmin();
    }

    // Locations collection
    match /locations/{locationId} {
      // Admins can read all locations
      // Org users can read locations assigned to their organization
      allow read: if isAdmin() || (
        isOrgUser() &&
        resource.data.assignedOrganizationId == getOrganizationId()
      );
      
      // Only admins can write locations
      allow write: if isAdmin();
      
      // Tasks subcollection
      match /tasks/{taskId} {
        // Same rules as location (inherit organization-based access)
        allow read: if isAdmin() || (
          isOrgUser() &&
          get(/databases/$(database)/documents/locations/$(locationId)).data.assignedOrganizationId == getOrganizationId()
        );
        
        allow write: if isAdmin();
        
        // Instructions subcollection
        match /instructions/{instructionId} {
          // Same rules as tasks
          allow read: if isAdmin() || (
            isOrgUser() &&
            get(/databases/$(database)/documents/locations/$(locationId)).data.assignedOrganizationId == getOrganizationId()
          );
          
          allow write: if isAdmin();
        }
      }
    }

    // Teleoperators collection
    match /teleoperators/{teleoperatorId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.organizationId == getOrganizationId())
      );
      allow write: if isAdmin();
    }

    // Task Completions collection
    match /taskCompletions/{completionId} {
      // Org users can read completions for their organization
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.organizationId == getOrganizationId())
      );
      
      // Only field workers can create completions, and only for their organization
      allow create: if isAuthenticated() &&
        isFieldWorker() &&
        request.resource.data.organizationId == getOrganizationId();
      
      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }

    // Legacy collections (for backward compatibility)
    match /taskTemplates/{templateId} {
      allow read: if partnerMatches(resource.data.partnerOrgId);
      allow write: if isAdmin();
    }

    match /tasks/{taskId} {
      allow read: if partnerMatches(resource.data.partnerOrgId);
      allow create: if isAdmin();
      allow delete: if isAdmin();
      allow update: if isAdmin();

      match /media/{mediaId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
    }

    // Sessions collection (location-based session tracking)
    match /sessions/{sessionId} {
      // Org users can read sessions for their organization
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isOrgUser() && resource.data.organizationId == getOrganizationId())
      );
      
      // Field workers can create their own sessions
      allow create: if isAuthenticated() &&
        isFieldWorker() &&
        request.resource.data.organizationId == getOrganizationId();
      
      // Field workers can update their own sessions
      allow update: if isAuthenticated() &&
        isFieldWorker() &&
        resource.data.organizationId == getOrganizationId();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }

    match /locationNotes/{noteId} {
      allow read: if partnerMatches(resource.data.partnerOrgId);
      allow create: if isAuthenticated()
        && partnerMatches(request.resource.data.partnerOrgId)
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.content is string;
      allow delete: if isAdmin() || request.auth.uid == resource.data.authorId;
    }

    match /auditLogs/{document=**} {
      allow read: if isAdmin();
      allow create: if isAdmin();
    }
  }
}
